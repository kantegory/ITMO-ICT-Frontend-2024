<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Авторизация и Регистрация</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #1a001a; /* Тёмно-фиолетовый фон */
      color: #e0d4ff; /* Светлый текст */
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
<div class="container mt-5">
  <!-- Форма для входа -->
  <form id="loginForm">
    <h2>Авторизация</h2>
    <div class="mb-3">
      <label for="loginUsername" class="form-label">Имя пользователя</label>
      <input type="text" class="form-control" id="loginUsername" required>
    </div>
    <div class="mb-3">
      <label for="loginPassword" class="form-label">Пароль</label>
      <input type="password" class="form-control" id="loginPassword" required>
    </div>
    <button type="submit" class="btn btn-primary">Войти</button>
    <p class="mt-3">
      Нет аккаунта? <a href="#" id="switchToRegister">Зарегистрироваться</a>
    </p>
  </form>
  <div id="loginErrorMessage" class="text-danger mb-3"></div>

  <!-- Форма для регистрации -->
  <form id="registerForm" class="hidden">
    <h2>Регистрация</h2>
    <div class="mb-3">
      <label for="registerUsername" class="form-label">Имя пользователя</label>
      <input type="text" class="form-control" id="registerUsername" required>
    </div>
    <div class="mb-3">
      <label for="registerPassword" class="form-label">Пароль</label>
      <input type="password" class="form-control" id="registerPassword" required>
    </div>
    <button type="submit" class="btn btn-success">Зарегистрироваться</button>
    <p class="mt-3">
      Уже есть аккаунт? <a href="#" id="switchToLogin">Войти</a>
    </p>
  </form>
  <div id="registerMessage" class="text-success mt-3"></div>
</div>

<script>
  // Переключение между формами
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const switchToRegister = document.getElementById('switchToRegister');
  const switchToLogin = document.getElementById('switchToLogin');

  switchToRegister.addEventListener('click', (e) => {
    e.preventDefault();
    loginForm.classList.add('hidden');
    registerForm.classList.remove('hidden');
  });

  switchToLogin.addEventListener('click', (e) => {
    e.preventDefault();
    registerForm.classList.add('hidden');
    loginForm.classList.remove('hidden');
  });

  // Логика входа
  const loginErrorMessage = document.getElementById('loginErrorMessage');

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;

    try {
      const response = await fetch('http://localhost:3000/users');
      if (!response.ok) {
        throw new Error('Ошибка подключения к базе данных.');
      }

      const users = await response.json();
      const user = users.find((u) => u.username === username && u.password === password);

      if (!user) {
        throw new Error('Неверный логин или пароль.');
      }

      // Сохраняем токен в localStorage
      localStorage.setItem('userToken', user.token);

      alert('Вход выполнен успешно!');
      console.log('Ваш токен:', user.token);
      window.location.href = 'profile.html';  // Переходим на страницу профиля
    } catch (error) {
      loginErrorMessage.textContent = error.message;
    }
  });

  // Логика регистрации
  const registerMessage = document.getElementById('registerMessage');

  registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const username = document.getElementById('registerUsername').value;
    const password = document.getElementById('registerPassword').value;

    try {
      const response = await fetch('http://localhost:3000/users');
      if (!response.ok) {
        throw new Error('Ошибка подключения к базе данных.');
      }

      const users = await response.json();
      const existingUser = users.find((u) => u.username === username);

      if (existingUser) {
        throw new Error('Пользователь с таким именем уже существует.');
      }

      const newUser = {
        username: username,
        password: password,
        token: `token-${Date.now()}`
      };

      const createResponse = await fetch('http://localhost:3000/users', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(newUser),
      });

      if (!createResponse.ok) {
        throw new Error('Ошибка при создании пользователя.');
      }

      // Сохраняем токен в localStorage
      localStorage.setItem('userToken', newUser.token);

      registerMessage.textContent = 'Регистрация успешна! Теперь вы можете войти.';
      registerMessage.classList.add('text-success');
    } catch (error) {
      registerMessage.textContent = error.message;
      registerMessage.classList.remove('text-success');
      registerMessage.classList.add('text-danger');
    }
  });
</script>
</body>
</html>
